package burp.util.vuln;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;

public class VulnerabilityPattern {
    
    private String id;
    private String name;
    private String category;
    private String description;
    private List<String> conditions;
    private List<String> suggestions;
    private int severity;
    private List<String> references;
    private Map<String, String> testPayloads;
    
    public VulnerabilityPattern() {
        this.conditions = new ArrayList<>();
        this.suggestions = new ArrayList<>();
        this.references = new ArrayList<>();
        this.testPayloads = new HashMap<>();
        this.severity = 3;
    }
    
    public VulnerabilityPattern(String id, String name, String category) {
        this();
        this.id = id;
        this.name = name;
        this.category = category;
    }
    
    public boolean matches(VulnerabilityContext context) {
        if (conditions == null || conditions.isEmpty()) {
            return false;
        }
        
        for (String condition : conditions) {
            if (!evaluateCondition(condition, context)) {
                return false;
            }
        }
        
        return true;
    }
    
    private boolean evaluateCondition(String condition, VulnerabilityContext context) {
        if (condition == null || condition.isEmpty()) {
            return false;
        }
        
        String[] parts = condition.split(":", 2);
        if (parts.length != 2) {
            return false;
        }
        
        String source = parts[0].trim().toLowerCase();
        String pattern = parts[1].trim();
        
        String value = null;
        
        switch (source) {
            case "header":
                value = context.getHeaderValue(pattern);
                break;
            case "body":
            case "response":
                value = context.getResponseBody();
                break;
            case "request":
                value = context.getRequestBody();
                break;
            case "url":
            case "path":
                value = context.getRequestPath();
                break;
            case "param":
                String[] paramParts = pattern.split(":", 2);
                if (paramParts.length == 2) {
                    value = context.getParameterValue(paramParts[0]);
                    pattern = paramParts[1];
                } else {
                    value = context.getParameterNames().toString();
                }
                break;
            case "cookie":
                value = context.getCookieValue(pattern);
                break;
            case "tech":
            case "technology":
                value = context.getTechnologies().toString();
                break;
            default:
                Object fieldValue = context.getFieldValue(source);
                value = fieldValue != null ? fieldValue.toString() : null;
        }
        
        if (value == null) {
            return false;
        }
        
        try {
            return Pattern.compile(pattern, Pattern.CASE_INSENSITIVE).matcher(value).find();
        } catch (Exception e) {
            return value.toLowerCase().contains(pattern.toLowerCase());
        }
    }
    
    public String getId() {
        return id;
    }
    
    public void setId(String id) {
        this.id = id;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getCategory() {
        return category;
    }
    
    public void setCategory(String category) {
        this.category = category;
    }
    
    public String getDescription() {
        return description;
    }
    
    public void setDescription(String description) {
        this.description = description;
    }
    
    public List<String> getConditions() {
        return new ArrayList<>(conditions);
    }
    
    public void setConditions(List<String> conditions) {
        this.conditions = conditions != null ? new ArrayList<>(conditions) : new ArrayList<>();
    }
    
    public void addCondition(String condition) {
        if (condition != null && !conditions.contains(condition)) {
            conditions.add(condition);
        }
    }
    
    public List<String> getSuggestions() {
        return new ArrayList<>(suggestions);
    }
    
    public void setSuggestions(List<String> suggestions) {
        this.suggestions = suggestions != null ? new ArrayList<>(suggestions) : new ArrayList<>();
    }
    
    public void addSuggestion(String suggestion) {
        if (suggestion != null && !suggestions.contains(suggestion)) {
            suggestions.add(suggestion);
        }
    }
    
    public int getSeverity() {
        return severity;
    }
    
    public void setSeverity(int severity) {
        this.severity = Math.max(1, Math.min(5, severity));
    }
    
    public String getSeverityLevel() {
        switch (severity) {
            case 5: return "严重";
            case 4: return "高危";
            case 3: return "中危";
            case 2: return "低危";
            case 1: return "信息";
            default: return "未知";
        }
    }
    
    public List<String> getReferences() {
        return new ArrayList<>(references);
    }
    
    public void setReferences(List<String> references) {
        this.references = references != null ? new ArrayList<>(references) : new ArrayList<>();
    }
    
    public Map<String, String> getTestPayloads() {
        return new HashMap<>(testPayloads);
    }
    
    public void setTestPayloads(Map<String, String> testPayloads) {
        this.testPayloads = testPayloads != null ? new HashMap<>(testPayloads) : new HashMap<>();
    }
    
    public void addTestPayload(String name, String payload) {
        testPayloads.put(name, payload);
    }
    
    @Override
    public String toString() {
        return "VulnerabilityPattern{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", category='" + category + '\'' +
                ", severity=" + getSeverityLevel() +
                '}';
    }
}
